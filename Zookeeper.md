##### 简单介绍下zookeeper

ZooKeeper 是一个开放源码的分布式协调服务，它是集群的管理者，监视着集群 中各个节点的状态根据节点提交的反馈进行下一步合理操作，提供了**文件系统**和**通知 机制**

可以实现分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能

##### zookeeper 负载均衡和 nginx 负载均衡区别

zk 的负载均衡是可以调控，nginx 只是能调权重，其他需要可控的都需要自己写 插件；但是 nginx 的吞吐量比 zk 大很多，应该说按业务选择用哪种方式

##### Zookeeper 有哪几种几种部署模式？

部署模式：单机模式、伪集群模式、集群模式。

##### 集群最少要几台机器，集群规则是怎样的?

2N+1 台，N>0，即 3 台。

##### zookeeper 是如何保证事务的顺序一致性的？

采用了全局递增的事务 Id 来标识，
所有的 proposal（提议）都在被提出的时候加上了

##### Zookeeper Watcher 机制 -- 数据变更通知

Zookeeper 允许客户端向服务端的某个 Znode 注册一个 Watcher 监听，当服务 端的一些指定事件触发了这个 Watcher，服务端会向指定客户端发送一个事件通 知来实现分布式的通知功能，然后客户端根据 Watcher 通知状态和事件类型做出 业务上的改变。

1、客户端注册 watcher 2、服务端处理 watcher 3、客户端回调 watcher

##### 服务器角色

**Leader** 

1、事务请求的唯一调度和处理者，保证集群事务处理的顺序性 2、集群内部各服务的调度者 

**Follower** 

1、处理客户端的非事务请求，转发事务请求给 Leader 服务器 2、参与事务请求 Proposal 的投票 3、参与 Leader 选举投票 

**Observer**

 1、3.0 版本以后引入的一个服务器角色，在不影响集群事务处理能力的基础上提 升集群的非事务处理能力 2、处理客户端的非事务请求，转发事务请求给 Leader 服务器 3、不参与任何形式的投票

##### 数据同步

Leader选举完成，其他服务器向leader注册后，会进行数据同步环节，再同步确认

##### 说几个 zookeeper 常用的命令

ls get set create delete

##### Zookeeper 的 java 客户端都有哪些？

客户端：zk 自带的 zkclient 及 Apache 开源的 Curator。协议ZAB

##### 功能应用场景

**命名服务**（文件系统）是指通过指定的名字来获取资源或者服务的地址，利用 zk 创建一个全局 的路径

**配置管理**（文件系统，通知机制）

程序分布式的部署在不同的机器上，将程序的配置信息放在 zk 的 znode 下，当有 配置发生改变时，也就是 znode 发生变化时，可以通过改变 zk 中某个目录节点的 内容，利用 watcher 通知给各个客户端，从而更改配置

**集群管理**

两点：是否有机器退出和加入、选举 master

对于第一点，所有机器约定在父目录下创建临时目录节点，然后监听父目录节点 的子节点变化消息。一旦有机器挂掉，该机器与 zookeeper 的连接断开，其所创 建的临时目录节点被删除，所有其他机器都收到通知：某个兄弟目录被删除，于 是，所有人都知道：它上船了。 新机器加入也是类似，所有机器收到通知：新兄弟目录加入，highcount 又有了，

对于第二点，我们稍微改变一下，所有机器创建临时顺序编号目录节点，每次选 取编号最小的机器作为 master 就好。

**分布式锁**

锁服务可以分为两类， 一个是保持独占，另一个是控制时序

对于第一类，我们将 zookeeper 上的一个 znode 看作是一把锁，通过 createznode 的方式来实现。所有客户端都去创建 /distribute_lock 节点，最终成功创建的那 个客户端也即拥有了这把锁。用完删除掉自己创建的 distribute_lock 节点就释放 出锁。 

对于第二类， /distribute_lock 已经预先存在，所有客户端在它下面创建临时顺 序编号目录节点，和选 master 一样，编号最小的获得锁，用完删除，依次方便

**队列管理**

- 同步队列，当一个队列的成员都聚齐时，这个队列才可用，否则一直等待所有 成员到达。

解决方案：在约定目录下创建临时目录节点，监听节点数目是否是我们要求的数目

- 队列按照 FIFO 方式进行入队和出队操作

入列有编号，出列按 编号。在特定的目录下创建 PERSISTENT_SEQUENTIAL 节点，创建成功时 Watcher 通知等待的队列，队列删除序列号最小的节点用以消费。此场景下 Zookeeper 的 znode 用于消息存储，znode 存储的数据就是消息队列中的消息内 容，SEQUENTIAL 序列号就是消息的编号，按序取出即可。由于创建的节点是持 久化的，所以不必担心队列消息的丢失问题。